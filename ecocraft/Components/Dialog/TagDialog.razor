@using ecocraft.Models
@using ecocraft.Services
@inject ContextService ContextService
@inject PriceCalculatorService PriceCalculatorService
@inject UserServerDataService UserServerDataService

<MudDialogContent>
    <MudContainer MaxWidth="MaxWidth.Medium" Style="min-width: 200px; height: auto;" Class="pa-0">
        @{
            var userPriceTag = UserServerDataService.UserPrices.First(up => up.ItemOrTag == Tag);

            <MudTable Items="Tag.AssociatedItems" Elevation="0" Class="pa-0" Dense="true">
                <RowTemplate>
                    @{
                        var userPriceItem = UserServerDataService.UserPrices.FirstOrDefault(up => up.ItemOrTag == context);

                        <MudTd>
                            @if (userPriceItem is not null)
                            {
                                <MudIconButton Icon="@(userPriceTag.PrimaryUserPrice == userPriceItem ? Icons.Material.Filled.Star : Icons.Material.Filled.StarOutline)"
                                               Size="Size.Small"
                                               OnClick="@(() => SetPrimaryUserPrice(userPriceTag, userPriceItem))"/>
                            }
                            else
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Block"
                                               Size="Size.Small"/>
                            }
                        </MudTd>
                        <MudTd>
                            <MudText Class="pt-1 pl-1">@ContextService.GetTranslation(context)</MudText>
                        </MudTd>
                        <MudTd>
                            @if (userPriceItem is not null)
                            {
                                <MudNumericField T="float?" Style="height: 25px; width: 125px" HideSpinButtons="true" Format="N2" Disabled="true" Value="@userPriceItem.Price" Variant="Variant.Outlined" />
                            }
                        </MudTd>
                    }
                </RowTemplate>
            </MudTable>
        }
    </MudContainer>
</MudDialogContent>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public ItemOrTag Tag { get; set; }

    private void Ok()
    {
        MudDialog.Cancel();
    }

    private async Task SetPrimaryUserPrice(UserPrice userPrice, UserPrice target)
    {
        userPrice.PrimaryUserPrice = target;
        await PriceCalculatorService.Calculate();
    }

}
