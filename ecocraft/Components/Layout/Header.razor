@implements IDisposable
@using ecocraft.Components.Dialog
@using ecocraft.Extensions
@using ecocraft.Models
@using ecocraft.Services
@using ecocraft.Services.DbServices
@inject EcoCraftDbContext EcoCraftDbContext
@inject ContextService ContextService
@inject IDialogService DialogService
@inject ServerDbService ServerDbService
@inject UserServerDataService UserServerDataService
@inject UserDbService UserDbService
@inject ServerDataService ServerDataService
@inject ISnackbar Snackbar

<MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
     <!--<MudIconButton Icon="@Icons.Material.Filled.Save" Color="Color.Tertiary" aria-label="Save data" OnClick="Save" />-->

     <MudTextField @bind-Value="joinCode" Variant="Variant.Outlined"> </MudTextField>
     <MudButton HtmlTag="label"
                Variant="Variant.Filled"
                Color="Color.Primary"
                OnClick="onJoinServer">
         Join
     </MudButton>
     
     <MudIcon Icon="@Icons.Material.Filled.LightMode" />
     <MudSwitch Value="isDarkMode" Color="Color.Primary" Class="ma-4" T="bool" ValueChanged="OnDarkModeChanged"/>

     <MudPaper Elevation="3" Style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
        <MudText>@ServerDataService.JoinCode</MudText>

        <MudSelect T="Server" Label="Server" Value="@ContextService.CurrentServer" Dense="false" Variant="Variant.Outlined" SelectedValuesChanged="OnSelectedServerChanged" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
            @foreach (var server in ContextService.AvailableServers)
            {
                <MudSelectItem T="Server" Value="@server">@server.Name</MudSelectItem>
            }
        </MudSelect>
        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Tertiary" aria-label="Create Server" OnClick="CreateServer" />
     </MudPaper>

     

    <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudText>@ContextService.CurrentUser?.Pseudo</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Tertiary" aria-label="Edit User" OnClick="EditUserDialog"/>
    </MudStack>

    <MudSelect T="LanguageCode" Label="Language" Value="@ContextService.CurrentLanguageCode" Dense="false" Variant="Variant.Outlined" SelectedValuesChanged="OnSelectedLanguageChanged" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
        @foreach (var supportedLanguages in LocalizedField.SupportedLanguageToCode)
        {
        <MudSelectItem T="LanguageCode" Value="@supportedLanguages.Value">@supportedLanguages.Key</MudSelectItem>
        }
    </MudSelect>
</MudStack>

@code {
    [Parameter]
    public bool isDarkMode { get; set; }

    [Parameter]
    public EventCallback<bool> isDarkModeChanged { get; set; }

    public string joinCode { get; set; } = "";

    IList<IBrowserFile> _files = new List<IBrowserFile>();

    protected override void OnInitialized()
    {
        ContextService.OnContextChanged += StateHasChanged;
    }

    public void Dispose()
    {
        ContextService.OnContextChanged -= StateHasChanged;
    }

    private async Task OnDarkModeChanged(bool newValue)
    {
        isDarkMode = newValue;
        await isDarkModeChanged.InvokeAsync(newValue); // Notifie le parent
    }

    private async Task OnSelectedLanguageChanged(IEnumerable<LanguageCode> languageCodes)
    {
        await ContextService.ChangeLanguage(languageCodes.First());
    }

    private async Task OnSelectedServerChanged(IEnumerable<Server> servers)
    {
        await ContextService.ChangeServer(servers.First());
    }

    private async Task Save()
    {
        await EcoCraftDbContext.SaveChangesAsync();
    }

    private async Task CreateServer()
    {
        var parameters = new DialogParameters();
        var dialog = DialogService.Show<ServerDialog>("Create server", parameters);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Server newServer = new Server { Name = result.Data.ToString()!, IsDefault = false};
            newServer.GenerateJoinCode();
            await ServerDbService.AddAndSave(newServer);

            await JoinServer(newServer, true);
        }
    }

    private async Task EditUserDialog()
    {
        var parameters = new DialogParameters
        {
            ["Pseudo"] = ContextService.CurrentUser!.Pseudo,
        };
        var dialog = DialogService.Show<UserDialog>("Create user", parameters);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            ContextService.CurrentUser.Pseudo = result.Data.ToString()!;
            await UserDbService.UpdateAndSave(ContextService.CurrentUser);
        }
    }

    private async Task onJoinServer()
    {
        var server = ServerDbService.GetByJoinCodeAsync(joinCode).Result;
        if(server is not null)
            await JoinServer(server);
        else
        {
            this.Snackbar.Clear();
            this.Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopRight;
            this.Snackbar.Add("Server not found", Severity.Error);
        }        
    }

    private async Task JoinServer(Server server, bool isAdmin = false)
    {
        if (ContextService.AvailableServers.Contains(server))
        {
            this.Snackbar.Clear();
            this.Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopRight;
            this.Snackbar.Add("You are already in this server", Severity.Warning);
            return;
        }


        UserServer userServer = new UserServer
            {
                UserId = ContextService.CurrentUser!.Id,
                ServerId = server.Id,
                IsAdmin = isAdmin,
                Pseudo = ContextService.CurrentUser.Pseudo,
            };

        userServer.UserSettings.Add(new UserSetting
            {
                UserServer = userServer,
            });

        ContextService.CurrentUser.UserServers.Add(userServer);
        await EcoCraftDbContext.SaveChangesAsync();

        await ContextService.ChangeServer(server);
    }
}